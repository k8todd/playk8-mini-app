<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PlayK8 - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://k8play7.com/">
  <link rel="dns-prefetch" href="https://k8play7.com/">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; width: 100%; background-color: #121212; }
    .container { display: flex; flex-direction: column; min-height: 100%; width: 100%; position: relative; }
    iframe { flex: 1; width: 100%; height: 100%; border: none; }
    
    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      transition: background-color 0.2s;
    }
    
    .back-button:hover {
      background-color: rgba(0, 0, 0, 0.9);
    }
    
    .back-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    
    /* 快捷按钮容器 */
    .shortcut-buttons {
      position: fixed;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1001;
      transition: all 0.3s ease;
    }
    
    /* 收起状态 */
    .shortcut-buttons.collapsed {
      gap: 5px;
    }
    
    .shortcut-buttons.collapsed .shortcut-btn {
      width: 32px;
      height: 32px;
      opacity: 0.7;
    }
    
    .shortcut-buttons.collapsed .shortcut-btn svg {
      width: 16px;
      height: 16px;
    }
    
    .shortcut-buttons.collapsed .shortcut-btn:hover {
      opacity: 1;
    }
    
    /* 收起/展开切换按钮 */
    .shortcut-toggle {
      position: fixed;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2996E4, #2996E4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(41, 150, 228, 0.4);
      z-index: 1002;
    }
    
    .shortcut-toggle:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(41, 150, 228, 0.6);
    }
    
    .shortcut-toggle svg {
      width: 20px;
      height: 20px;
      fill: white;
      transition: transform 0.3s ease;
    }
    
    .shortcut-toggle.expanded svg {
      transform: rotate(180deg);
    }
    

    
    /* 快捷按钮样式 */
    .shortcut-btn {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2996E4, #2996E4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(41, 150, 228, 0.4);
      opacity: 0.76;
    }
    
    .shortcut-btn:hover {
      transform: scale(1.1);
      opacity: 1;
      box-shadow: 0 6px 20px rgba(41, 150, 228, 0.6);
    }
    
    .shortcut-btn:active {
      transform: scale(0.95);
    }
    
    /* 按钮图标 */
    .shortcut-btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    
    /* 按钮标签 */
    .shortcut-btn::after {
      content: attr(data-label);
      position: absolute;
      right: 70px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .shortcut-btn:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-button" id="backButton">
      <svg viewBox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
    </div>
    
    <!-- 快捷按钮容器 -->
    <div class="shortcut-buttons" id="shortcutButtons">
      <!-- 钱包按钮 -->
      <div class="shortcut-btn" id="walletBtn" data-label="钱包充值">
        <svg viewBox="0 0 24 24">
          <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </svg>
      </div>
      
      <!-- 收藏按钮 -->
      <div class="shortcut-btn" id="favoritesBtn" data-label="我的收藏">
        <svg viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
      </div>
      
      <!-- 首页按钮 -->
      <div class="shortcut-btn" id="homeBtn" data-label="返回首页">
        <svg viewBox="0 0 24 24">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
      </div>
    </div>
    
    <!-- 快捷按钮切换按钮 -->
    <div class="shortcut-toggle" id="shortcutToggle">
      <svg viewBox="0 0 24 24">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
      </svg>
    </div>
    <iframe id="gameFrame" src="about:blank" allowfullscreen allow="camera; microphone; geolocation; payment; usb; magnetometer; gyroscope; accelerometer; ambient-light-sensor; autoplay; encrypted-media; midi; sync-xhr; clipboard-read; clipboard-write" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-storage-access-by-user-activation allow-top-navigation"></iframe>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const param = tg.initDataUnsafe?.start_param;
    const userId = tg.initDataUnsafe?.user?.id;
    const username = tg.initDataUnsafe?.user?.username;
    const firstName = tg.initDataUnsafe?.user?.first_name;

    const userLang = tg.initDataUnsafe?.user?.language_code || 'en';
    const translations = {
      en: { exitConfirm: 'Are you sure you want to exit the game?' },
      ja: { exitConfirm: 'ゲームを終了してもよろしいですか？' },
      zh: { exitConfirm: '确定要退出游戏吗？' }
    };
    const t = translations[userLang] || translations.en;

    const gameFrame = document.getElementById('gameFrame');
    const backButton = document.getElementById('backButton');
    const shortcutButtons = document.getElementById('shortcutButtons');
    const walletBtn = document.getElementById('walletBtn');
    const favoritesBtn = document.getElementById('favoritesBtn');
    const homeBtn = document.getElementById('homeBtn');

    // 构建包含用户信息的游戏URL
    const baseGameUrl = 'https://k8play7.com/';
    const urlParams = new URLSearchParams();
    if (param) urlParams.append('invite', param);
    if (userId) urlParams.append('tg_user_id', userId);
    if (username) urlParams.append('tg_username', username);
    if (firstName) urlParams.append('tg_first_name', firstName);
    urlParams.append('tg_lang', userLang);
    urlParams.append('tg_platform', tg.platform);
    urlParams.append('tg_version', tg.version);
    urlParams.append('tg_theme', tg.colorScheme || 'light');
    urlParams.append('tg_init_data', tg.initData || '');
    
    // 添加登录状态标识
    urlParams.append('tg_source', 'telegram_mini_app');
    urlParams.append('tg_auto_login', 'true');
    
    const gameUrl = urlParams.toString() ? `${baseGameUrl}?${urlParams.toString()}` : baseGameUrl;

    // 网络状态监测
    let isOnline = navigator.onLine;
    window.addEventListener('online', () => {
      isOnline = true;
      trackEvent('network_online');
      try {
        gameFrame.contentWindow?.postMessage({
          type: 'network_status',
          online: true
        }, '*');
      } catch (e) {
        console.log('发送网络状态失败:', e.message);
      }
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      trackEvent('network_offline');
      tg.showAlert('网络连接已断开 / Network disconnected / ネットワーク接続が切断されました');
      try {
        gameFrame.contentWindow?.postMessage({
          type: 'network_status',
          online: false
        }, '*');
      } catch (e) {
        console.log('发送网络状态失败:', e.message);
      }
    });

    // 设备信息
    function getDeviceInfo() {
      return {
        platform: tg.platform,
        version: tg.version,
        colorScheme: tg.colorScheme,
        viewportHeight: tg.viewportHeight,
        viewportStableHeight: tg.viewportStableHeight,
        isExpanded: tg.isExpanded,
        language: userLang,
        online: isOnline
      };
    }

    // 用户行为分析
    function trackEvent(eventName, data = {}) {
      const eventData = {
        event: eventName,
        user_id: userId,
        username: username,
        platform: tg.platform,
        timestamp: new Date().toISOString(),
        ...data
      };
      
      // 发送给游戏iframe
      if (gameFrame.contentWindow) {
        try {
          gameFrame.contentWindow.postMessage({
            type: 'tg_analytics',
            data: eventData
          }, '*');
        } catch (e) {
          console.log('发送分析数据失败:', e.message);
        }
      }
      
      console.log('Track event:', eventData);
    }

    function loadGame() {
      trackEvent('app_start', { invite_code: param });
      
      // 尝试恢复登录状态
      const savedLoginState = localStorage.getItem('k8play_login_state');
      let finalGameUrl = gameUrl;
      
      if (savedLoginState) {
        try {
          const loginData = JSON.parse(savedLoginState);
          // 如果登录状态未过期，使用保存的URL
          if (loginData.expiresAt && new Date() < new Date(loginData.expiresAt)) {
            finalGameUrl = loginData.url;
            console.log('恢复登录状态:', loginData);
          }
        } catch (e) {
          console.log('登录状态恢复失败:', e);
        }
      }
      
      gameFrame.src = finalGameUrl;
      gameFrame.onload = () => {
        tg.ready();
        trackEvent('game_loaded');
        
        // 初始化导航历史
        navigationHistory = [finalGameUrl];
        currentHistoryIndex = 0;
        
        // 开始跟踪导航
        trackNavigation();
        
        // 启用增强的导航跟踪
        enhancedNavigationTracking();
        
        // 设置定时器监听URL变化（对于单页应用）- 减少频率
        setInterval(trackNavigation, 2000);
        
        // 监听登录状态变化
        setTimeout(() => {
          try {
            gameFrame.contentWindow.postMessage({
              type: 'request_login_state',
              user_id: userId,
              username: username
            }, '*');
          } catch (e) {
            console.log('发送登录状态请求失败:', e.message);
          }
          
          // 注入登录状态管理脚本到游戏页面
          injectLoginStateScript();
          
          // 检查并处理自动登录
          checkAndHandleAutoLogin();
          
              // 初始化快捷按钮
    initShortcutButtons();
    
    // 主动检测当前URL状态
    setTimeout(() => {
      const currentSrc = gameFrame.src;
      if (currentSrc && currentSrc !== 'about:blank') {
        const isExternal = isExternalGameDomain(currentSrc);
        toggleShortcutButtons(isExternal);
        console.log('游戏加载完成后的主动检测:', currentSrc, 'isExternal:', isExternal);
        
        // 尝试检测嵌套iframe中的实际游戏URL
        try {
          const nestedFrames = gameFrame.contentDocument.querySelectorAll('iframe');
          if (nestedFrames.length > 0) {
            for (let i = 0; i < nestedFrames.length; i++) {
              const nestedFrame = nestedFrames[i];
              if (nestedFrame.src && nestedFrame.src !== 'about:blank') {
                const nestedIsExternal = isExternalGameDomain(nestedFrame.src);
                console.log('检测到嵌套iframe:', nestedFrame.src, 'isExternal:', nestedIsExternal);
                if (nestedIsExternal) {
                  toggleShortcutButtons(true);
                  console.log('嵌套iframe检测到外部游戏，显示快捷按钮');
                  break;
                }
              }
            }
          }
        } catch (e) {
          console.log('无法访问嵌套iframe（跨域限制）');
        }
        
        // 基于游戏特征强制显示快捷按钮
        // 如果检测到游戏相关元素或特征，强制显示快捷按钮
        setTimeout(() => {
          try {
            // 检查是否有游戏相关元素
            const hasCanvas = gameFrame.contentDocument.querySelector('canvas');
            const hasGameElements = gameFrame.contentDocument.querySelectorAll('[class*="game"], [id*="game"], [class*="slot"], [id*="slot"]');
            const hasGameScripts = gameFrame.contentDocument.querySelectorAll('script[src*="game"], script[src*="slot"]');
            
            if (hasCanvas || hasGameElements.length > 0 || hasGameScripts.length > 0) {
              console.log('检测到游戏元素，强制显示快捷按钮');
              console.log('- Canvas:', !!hasCanvas);
              console.log('- Game elements:', hasGameElements.length);
              console.log('- Game scripts:', hasGameScripts.length);
              toggleShortcutButtons(true);
            }
          } catch (e) {
            console.log('无法检查游戏元素（跨域限制）');
          }
        }, 2000);
        
        // 备用方案：基于时间延迟强制显示快捷按钮
        // 如果游戏加载超过8秒，假设已经进入外部游戏
        setTimeout(() => {
          console.log('8秒后强制显示快捷按钮（备用方案）');
          toggleShortcutButtons(true);
          
        }, 8000);
        
        // 监听游戏加载完成事件
        const checkGameLoaded = () => {
          try {
            // 检查是否有游戏相关的全局变量或对象
            const hasGameWindow = gameFrame.contentWindow && (
              gameFrame.contentWindow.game ||
              gameFrame.contentWindow.Game ||
              gameFrame.contentWindow.slot ||
              gameFrame.contentWindow.Slot ||
              gameFrame.contentWindow.artemis ||
              gameFrame.contentWindow.Artemis
            );
            
            if (hasGameWindow) {
              console.log('检测到游戏对象，显示快捷按钮');
              toggleShortcutButtons(true);
              
              return true;
            }
          } catch (e) {
            // 跨域限制，忽略
          }
          return false;
        };
        
        // 定期检查游戏是否加载完成
        const gameCheckInterval = setInterval(() => {
          if (checkGameLoaded()) {
            clearInterval(gameCheckInterval);
          }
        }, 1000);
        
        // 10秒后停止检查
        setTimeout(() => {
          clearInterval(gameCheckInterval);
        }, 10000);
        
      }
    }, 3000);
    

        }, 2000);
      };
      gameFrame.onerror = () => {
        console.error('Failed to load game');
        tg.showAlert('Failed to load game. Please try again later.');
        trackEvent('game_load_error');
      };
    }

    let resizeTimeout;
    function resizeIframe() {
      if (resizeTimeout) cancelAnimationFrame(resizeTimeout);
      resizeTimeout = requestAnimationFrame(() => {
        gameFrame.style.height = window.innerHeight + 'px';
      });
    }

    resizeIframe();
    window.addEventListener('resize', resizeIframe);

    // 自动登录检测和处理
    function checkAndHandleAutoLogin() {
      // 检查是否有保存的登录状态
      const savedLoginState = localStorage.getItem('k8play_login_state');
      if (savedLoginState) {
        try {
          const loginData = JSON.parse(savedLoginState);
          if (loginData.expiresAt && new Date() < new Date(loginData.expiresAt)) {
            // 登录状态有效，尝试自动登录
            console.log('检测到有效登录状态，尝试自动登录');
            
            // 向游戏发送自动登录请求
            setTimeout(() => {
              try {
                gameFrame.contentWindow.postMessage({
                  type: 'auto_login_request',
                  user_id: loginData.user_id,
                  username: loginData.username,
                  saved_url: loginData.url
                }, '*');
              } catch (e) {
                console.log('发送自动登录请求失败:', e.message);
              }
            }, 1000);
          }
        } catch (e) {
          console.log('登录状态解析失败:', e);
        }
      }
    }

        // 注入登录状态管理脚本到游戏页面
    function injectLoginStateScript() {
      const loginScript = `
        (function() {
          // 登录状态管理
          window.k8playLoginManager = {
            // 检查是否在Telegram环境中
            isInTelegram: function() {
              return window.parent && window.parent !== window && 
                     window.parent.location.href.includes('telegram');
            },
            
            // 检查用户是否已登录
            isUserLoggedIn: function() {
              // 检查常见的登录标识
              return !!(
                document.cookie.includes('session') ||
                document.cookie.includes('token') ||
                document.cookie.includes('auth') ||
                localStorage.getItem('user') ||
                localStorage.getItem('token') ||
                localStorage.getItem('session') ||
                document.querySelector('[data-user]') ||
                document.querySelector('.user-info') ||
                document.querySelector('.logged-in')
              );
            },
            
            // 保存登录状态
            saveLoginState: function() {
              if (this.isInTelegram()) {
                window.parent.postMessage({
                  type: 'save_login_state',
                  url: window.location.href
                }, '*');
                console.log('登录状态已保存到Telegram应用');
              }
            },
            
            // 清除登录状态
            clearLoginState: function() {
              if (this.isInTelegram()) {
                window.parent.postMessage({
                  type: 'clear_login_state'
                }, '*');
                console.log('登录状态已从Telegram应用清除');
              }
            },
            
            // 监听登录状态请求
            init: function() {
              // 监听来自Telegram的消息
              window.addEventListener('message', (event) => {
                if (event.data.type === 'request_login_state') {
                  if (this.isUserLoggedIn()) {
                    this.saveLoginState();
                  }
                }
              });
              
              // 监听页面变化（用于单页应用）
              let currentUrl = window.location.href;
              const observer = new MutationObserver(() => {
                if (window.location.href !== currentUrl) {
                  currentUrl = window.location.href;
                  if (this.isUserLoggedIn()) {
                    this.saveLoginState();
                  }
                  
                  // 发送导航变化事件到Telegram应用
                  if (this.isInTelegram()) {
                    window.parent.postMessage({
                      type: 'navigation_change',
                      url: window.location.href
                    }, '*');
                    
                    // 检查是否在外部游戏域名
                    const isK8PlayDomain = window.location.hostname === 'k8play7.com' || 
                                          window.location.hostname.endsWith('.k8play7.com');
                    const isK8PlayUrl = window.location.href.startsWith('https://k8play7.com/');
                    const isInternal = isK8PlayDomain || isK8PlayUrl;
                    const isExternal = !isInternal;
                    
                    window.parent.postMessage({
                      type: 'external_domain_check',
                      isExternal: isExternal,
                      url: window.location.href,
                      hostname: window.location.hostname
                    }, '*');
                  }
                }
              });
              observer.observe(document.body, { childList: true, subtree: true });
              
              // 监听pushState和replaceState（SPA路由变化）
              const originalPushState = history.pushState;
              const originalReplaceState = history.replaceState;
              
              history.pushState = function() {
                originalPushState.apply(this, arguments);
                if (window.k8playLoginManager.isInTelegram()) {
                  window.parent.postMessage({
                    type: 'navigation_change',
                    url: window.location.href
                  }, '*');
                  
                  // 检查是否进入外部游戏
                  const isExternal = window.location.hostname !== 'k8play7.com' && 
                                   !window.location.hostname.endsWith('.k8play7.com');
                  if (isExternal) {
                    window.parent.postMessage({
                      type: 'game_state_change',
                      isExternal: true,
                      gameType: 'external_game',
                      url: window.location.href
                    }, '*');
                  }
                }
              };
              
              history.replaceState = function() {
                originalReplaceState.apply(this, arguments);
                if (window.k8playLoginManager.isInTelegram()) {
                  window.parent.postMessage({
                    type: 'navigation_change',
                    url: window.location.href
                  }, '*');
                  
                  // 检查是否进入外部游戏
                  const isExternal = window.location.hostname !== 'k8play7.com' && 
                                   !window.location.hostname.endsWith('.k8play7.com');
                  if (isExternal) {
                    window.parent.postMessage({
                      type: 'game_state_change',
                      isExternal: true,
                      gameType: 'external_game',
                      url: window.location.href
                    }, '*');
                  }
                }
              };
              
              // 监听popstate事件（浏览器前进后退）
              window.addEventListener('popstate', () => {
                if (window.k8playLoginManager.isInTelegram()) {
                  window.parent.postMessage({
                    type: 'navigation_change',
                    url: window.location.href
                  }, '*');
                }
              });
              
              // 监听表单提交（登录表单）
              document.addEventListener('submit', (event) => {
                const form = event.target;
                if (form.action && form.action.includes('login')) {
                  // 延迟检查登录状态
                  setTimeout(() => {
                    if (this.isUserLoggedIn()) {
                      this.saveLoginState();
                    }
                  }, 1000);
                }
              });
              
              // 监听AJAX请求完成
              const originalXHROpen = XMLHttpRequest.prototype.open;
              XMLHttpRequest.prototype.open = function() {
                this.addEventListener('load', function() {
                  if (this.responseURL && this.responseURL.includes('login')) {
                    setTimeout(() => {
                      if (window.k8playLoginManager.isUserLoggedIn()) {
                        window.k8playLoginManager.saveLoginState();
                      }
                    }, 500);
                  }
                });
                originalXHROpen.apply(this, arguments);
              };
              
              // 监听fetch请求
              const originalFetch = window.fetch;
              window.fetch = function() {
                return originalFetch.apply(this, arguments).then(response => {
                  if (response.url && response.url.includes('login')) {
                    setTimeout(() => {
                      if (window.k8playLoginManager.isUserLoggedIn()) {
                        window.k8playLoginManager.saveLoginState();
                      }
                    }, 500);
                  }
                  return response;
                });
              };
              
              // 定期检查登录状态
              setInterval(() => {
                if (this.isUserLoggedIn()) {
                  this.saveLoginState();
                }
              }, 30000); // 每30秒检查一次
              
              console.log('K8Play登录状态管理器已初始化');
            }
          };
          
          // 初始化登录状态管理器
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              window.k8playLoginManager.init();
            });
          } else {
            window.k8playLoginManager.init();
          }
          
          // 添加退出登录监听
          document.addEventListener('click', (event) => {
            const target = event.target;
            if (target.textContent.toLowerCase().includes('logout') ||
                target.textContent.toLowerCase().includes('退出') ||
                target.textContent.toLowerCase().includes('登出') ||
                target.href && target.href.includes('logout')) {
              setTimeout(() => {
                window.k8playLoginManager.clearLoginState();
              }, 500);
            }
          });
          
          // 检查URL参数来识别外部游戏
          const urlParams = new URLSearchParams(window.location.search);
          const hasGameParams = urlParams.has('game') || 
                              urlParams.has('gname') || 
                              urlParams.has('symbol') ||
                              urlParams.has('extGame');
          
          if (hasGameParams && window.k8playLoginManager.isInTelegram()) {
            // 如果有游戏参数，可能是外部游戏
            setTimeout(() => {
              window.parent.postMessage({
                type: 'game_state_change',
                isExternal: true,
                gameType: 'external_game',
                url: window.location.href,
                hostname: window.location.hostname
              }, '*');
            }, 1000);
          }
          
          // 监听页面标题变化来检测游戏状态
          const titleObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' && mutation.target.tagName === 'TITLE') {
                const title = document.title.toLowerCase();
                const isGameTitle = title.includes('game') || 
                                  title.includes('slot') || 
                                  title.includes('casino') ||
                                  title.includes('play') ||
                                  title.includes('bow of artemis') ||
                                  title.includes('artemis');
                
                if (isGameTitle && window.k8playLoginManager.isInTelegram()) {
                  setTimeout(() => {
                    window.parent.postMessage({
                      type: 'game_state_change',
                      isExternal: true,
                      gameType: 'external_game',
                      url: window.location.href,
                      hostname: window.location.hostname,
                      title: document.title
                    }, '*');
                  }, 500);
                }
              }
            });
          });
          
          if (document.title) {
            titleObserver.observe(document.querySelector('title') || document.head, { 
              childList: true, 
              subtree: true 
            });
          }
          
          // 监听游戏相关元素出现
          const gameElementObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList') {
                mutation.addedNodes.forEach((node) => {
                  if (node.nodeType === 1) {
                    // 检查是否包含游戏相关元素
                    const hasCanvas = node.querySelector && node.querySelector('canvas');
                    const hasGameClass = node.className && (
                      node.className.includes('game') ||
                      node.className.includes('slot') ||
                      node.className.includes('casino')
                    );
                    const hasGameId = node.id && (
                      node.id.includes('game') ||
                      node.id.includes('slot') ||
                      node.id.includes('casino')
                    );
                    
                    if ((hasCanvas || hasGameClass || hasGameId) && window.k8playLoginManager.isInTelegram()) {
                      setTimeout(() => {
                        window.parent.postMessage({
                          type: 'game_state_change',
                          isExternal: true,
                          gameType: 'external_game',
                          url: window.location.href,
                          hostname: window.location.hostname,
                          element: node.tagName + (node.className ? '.' + node.className : '') + (node.id ? '#' + node.id : '')
                        }, '*');
                      }, 500);
                    }
                  }
                });
              }
            });
          });
          
          gameElementObserver.observe(document.body, { 
            childList: true, 
            subtree: true 
          });
        })();
      `;
      
      try {
        // 尝试注入脚本到游戏页面
        if (gameFrame.contentWindow) {
          const scriptElement = gameFrame.contentWindow.document.createElement('script');
          scriptElement.textContent = loginScript;
          gameFrame.contentWindow.document.head.appendChild(scriptElement);
          console.log('登录状态管理脚本已注入到游戏页面');
        }
      } catch (e) {
        console.log('注入脚本失败（跨域限制）:', e.message);
        // 如果无法直接注入，通过postMessage发送脚本
        try {
          gameFrame.contentWindow.postMessage({
            type: 'inject_login_script',
            script: loginScript
          }, '*');
        } catch (postError) {
          console.log('postMessage发送脚本失败:', postError.message);
        }
      }
    }

    // 监听来自游戏的消息
    window.addEventListener('message', (event) => {
      // 放宽origin检查，允许来自任何域名的消息
      // if (event.origin !== baseGameUrl.replace(/\/$/, '')) return;
      
      // 处理游戏发来的消息
      if (event.data.type === 'game_event') {
        trackEvent(event.data.eventName, event.data.data);
      }
      
      // 处理登录状态保存
      if (event.data.type === 'save_login_state') {
        try {
          const loginState = {
            url: event.data.url || gameFrame.src,
            user_id: userId,
            username: username,
            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7天过期
            savedAt: new Date().toISOString()
          };
          localStorage.setItem('k8play_login_state', JSON.stringify(loginState));
          console.log('登录状态已保存:', loginState);
        } catch (e) {
          console.error('保存登录状态失败:', e);
        }
      }
      
      // 处理登录状态清除
      if (event.data.type === 'clear_login_state') {
        try {
          localStorage.removeItem('k8play_login_state');
          console.log('登录状态已清除');
        } catch (e) {
          console.error('清除登录状态失败:', e);
        }
      }
      
      // 处理脚本注入请求
      if (event.data.type === 'inject_login_script') {
        try {
          const scriptElement = document.createElement('script');
          scriptElement.textContent = event.data.script;
          document.head.appendChild(scriptElement);
          console.log('登录状态管理脚本已通过postMessage注入');
        } catch (e) {
          console.error('脚本注入失败:', e);
        }
      }
      
      // 处理自动登录响应
      if (event.data.type === 'auto_login_response') {
        if (event.data.success) {
          console.log('自动登录成功');
          trackEvent('auto_login_success');
        } else {
          console.log('自动登录失败:', event.data.reason);
          trackEvent('auto_login_failed', { reason: event.data.reason });
        }
      }
      
      // 处理外部域名检测
      if (event.data.type === 'external_domain_check') {
        const isExternal = event.data.isExternal;
        toggleShortcutButtons(isExternal);
        console.log('外部域名检测消息:', {
          isExternal: isExternal,
          url: event.data.url,
          hostname: event.data.hostname,
          action: isExternal ? '显示快捷按钮' : '隐藏快捷按钮'
        });
      }
      
      // 处理游戏状态变化
      if (event.data.type === 'game_state_change') {
        const isExternal = event.data.isExternal || false;
        toggleShortcutButtons(isExternal);
        console.log('游戏状态变化:', {
          isExternal: isExternal,
          gameType: event.data.gameType,
          action: isExternal ? '显示快捷按钮' : '隐藏快捷按钮'
        });
      }
      
      // 处理游戏请求Telegram操作
      if (event.data.type === 'tg_action') {
        switch (event.data.action) {
          case 'close':
            tg.close();
            break;
          case 'share':
            // 实现分享功能
            if (event.data.text && event.data.url) {
              const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(event.data.url)}&text=${encodeURIComponent(event.data.text)}`;
              tg.openTelegramLink(shareUrl);
            }
            break;
          case 'show_alert':
            tg.showAlert(event.data.message);
            break;
          case 'show_confirm':
            tg.showConfirm(event.data.message, (confirmed) => {
              try {
                gameFrame.contentWindow.postMessage({
                  type: 'tg_confirm_result',
                  id: event.data.id,
                  confirmed: confirmed
                }, '*');
              } catch (e) {
                console.log('发送确认结果失败:', e.message);
              }
            });
            break;
          case 'show_popup':
            if (event.data.params) {
              tg.showPopup(event.data.params, (buttonId) => {
                try {
                  gameFrame.contentWindow.postMessage({
                    type: 'tg_popup_result',
                    id: event.data.id,
                    buttonId: buttonId
                  }, '*');
                } catch (e) {
                  console.log('发送弹窗结果失败:', e.message);
                }
              });
            }
            break;
          case 'request_contact':
            tg.requestContact((shared) => {
              try {
                gameFrame.contentWindow.postMessage({
                  type: 'tg_contact_result',
                  shared: shared
                }, '*');
              } catch (e) {
                console.log('发送联系人结果失败:', e.message);
              }
            });
            break;
          case 'haptic':
            // 触觉反馈
            if (tg.HapticFeedback) {
              switch (event.data.style) {
                case 'light':
                  tg.HapticFeedback.impactOccurred('light');
                  break;
                case 'medium':
                  tg.HapticFeedback.impactOccurred('medium');
                  break;
                case 'heavy':
                  tg.HapticFeedback.impactOccurred('heavy');
                  break;
                case 'success':
                  tg.HapticFeedback.notificationOccurred('success');
                  break;
                case 'warning':
                  tg.HapticFeedback.notificationOccurred('warning');
                  break;
                case 'error':
                  tg.HapticFeedback.notificationOccurred('error');
                  break;
              }
            }
            break;
          case 'open_link':
            if (event.data.url) {
              tg.openLink(event.data.url);
            }
            break;
          case 'set_header_color':
            if (event.data.color) {
              tg.setHeaderColor(event.data.color);
            }
            break;
          case 'set_background_color':
            if (event.data.color) {
              tg.setBackgroundColor(event.data.color);
            }
            break;
          case 'get_device_info':
            try {
              gameFrame.contentWindow.postMessage({
                type: 'device_info',
                data: getDeviceInfo()
              }, '*');
            } catch (e) {
              console.log('发送设备信息失败:', e.message);
            }
            break;
          case 'enable_closing_confirmation':
            tg.enableClosingConfirmation();
            break;
          case 'disable_closing_confirmation':
            tg.disableClosingConfirmation();
            break;
          case 'ready_to_close':
            tg.ready();
            break;
          case 'scan_qr':
            if (tg.showScanQrPopup) {
              tg.showScanQrPopup({
                text: event.data.text || 'Scan QR Code'
              }, (text) => {
                try {
                  gameFrame.contentWindow.postMessage({
                    type: 'qr_scan_result',
                    text: text || null
                  }, '*');
                } catch (e) {
                  console.log('发送二维码扫描结果失败:', e.message);
                }
              });
            }
            break;
          case 'request_write_access':
            if (tg.requestWriteAccess) {
              tg.requestWriteAccess((granted) => {
                try {
                  gameFrame.contentWindow.postMessage({
                    type: 'write_access_result',
                    granted: granted
                  }, '*');
                } catch (e) {
                  console.log('发送写入权限结果失败:', e.message);
                }
              });
            }
            break;
          case 'request_phone':
            if (tg.requestContact) {
              tg.requestContact((result) => {
                try {
                  gameFrame.contentWindow.postMessage({
                    type: 'phone_result',
                    result: result
                  }, '*');
                } catch (e) {
                  console.log('发送手机号结果失败:', e.message);
                }
              });
            }
            break;
          case 'open_invoice':
            if (event.data.url && tg.openInvoice) {
              tg.openInvoice(event.data.url, (status) => {
                try {
                  gameFrame.contentWindow.postMessage({
                    type: 'invoice_status',
                    status: status
                  }, '*');
                } catch (e) {
                  console.log('发送发票状态失败:', e.message);
                }
              });
            }
            break;
          case 'navigate_to':
            // 游戏请求导航到指定URL
            if (event.data.url) {
              gameFrame.src = event.data.url;
            }
            break;
        }
      }
    });

    // 跟踪iframe导航历史
    let navigationHistory = [];
    let currentHistoryIndex = -1;
    let isNavigatingBack = false;

    // 监听iframe导航
    let lastTrackedUrl = '';
    let lastExternalState = null;
    let crossOriginLogged = false;
    
    function trackNavigation() {
      try {
        const currentUrl = gameFrame.contentWindow.location.href;
        if (!isNavigatingBack && currentUrl !== 'about:blank' && currentUrl !== lastTrackedUrl) {
          lastTrackedUrl = currentUrl;
          
          if (currentUrl !== navigationHistory[currentHistoryIndex]) {
            // 新导航，清除前进历史
            navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
            navigationHistory.push(currentUrl);
            currentHistoryIndex = navigationHistory.length - 1;
            
            // 如果有多个页面，显示返回按钮
            if (navigationHistory.length > 1) {
              if (tg.BackButton && tg.BackButton.show) {
                tg.BackButton.show();
              }
              backButton.style.display = 'flex';
            }
            
            // 检查是否在外部游戏域名，显示/隐藏快捷按钮
            const isExternal = isExternalGameDomain(currentUrl);
            if (isExternal !== lastExternalState) {
              lastExternalState = isExternal;
              toggleShortcutButtons(isExternal);
            }
            
          }
        }
        isNavigatingBack = false;
      } catch (e) {
        // 减少跨域限制日志输出
        if (!crossOriginLogged) {
          console.log('无法访问iframe location（跨域限制）');
          crossOriginLogged = true;
          // 5秒后重置日志标志
          setTimeout(() => {
            crossOriginLogged = false;
          }, 5000);
        }
        
        // 尝试通过src检测外部域名
        const currentSrc = gameFrame.src;
        if (currentSrc !== 'about:blank') {
          const isExternal = isExternalGameDomain(currentSrc);
          if (isExternal !== lastExternalState) {
            lastExternalState = isExternal;
            toggleShortcutButtons(isExternal);
          }
        }
        
        // 额外检查：监听iframe的load事件来检测URL变化
        if (!gameFrame.hasAttribute('data-url-monitoring')) {
          gameFrame.setAttribute('data-url-monitoring', 'true');
          gameFrame.addEventListener('load', () => {
            setTimeout(() => {
              const frameSrc = gameFrame.src;
              if (frameSrc && frameSrc !== 'about:blank') {
                const isExternal = isExternalGameDomain(frameSrc);
                if (isExternal !== lastExternalState) {
                  lastExternalState = isExternal;
                  toggleShortcutButtons(isExternal);
                }
              }
              
              // 尝试检测嵌套iframe
              try {
                const nestedFrames = gameFrame.contentDocument.querySelectorAll('iframe');
                if (nestedFrames.length > 0) {
                  for (let i = 0; i < nestedFrames.length; i++) {
                    const nestedFrame = nestedFrames[i];
                    if (nestedFrame.src && nestedFrame.src !== 'about:blank') {
                      const nestedIsExternal = isExternalGameDomain(nestedFrame.src);
                      if (nestedIsExternal) {
                        toggleShortcutButtons(true);
                        break;
                      }
                    }
                  }
                }
              } catch (e) {
                console.log('load事件无法访问嵌套iframe（跨域限制）');
              }
            }, 100);
          });
        }
      }
    }
    
    // 检查是否在外部游戏域名
    function isExternalGameDomain(url) {
      try {
        const urlObj = new URL(url);
        
        // 检查是否是k8play7.com或其子域名
        const isK8PlayDomain = urlObj.hostname === 'k8play7.com' || 
                              urlObj.hostname.endsWith('.k8play7.com');
        
        // 检查URL是否以https://k8play7.com/开头
        const isK8PlayUrl = url.startsWith('https://k8play7.com/');
        
        // 如果是k8play7.com域名或以k8play7.com开头的URL，则认为是内部链接
        const isInternal = isK8PlayDomain || isK8PlayUrl;
        const isExternal = !isInternal;
        
        return isExternal;
      } catch (e) {
        console.log('URL解析失败:', url, e);
        return false;
      }
    }
    
    // 显示/隐藏快捷按钮
    let lastShortcutState = null;
    
    function toggleShortcutButtons(show) {
      if (show !== lastShortcutState) {
        lastShortcutState = show;
        if (show) {
          shortcutButtons.style.display = 'flex';
        } else {
          shortcutButtons.style.display = 'none';
        }
      }
    }
    
    // 快捷按钮功能
    function initShortcutButtons() {
      // 钱包按钮 - 打开充值弹窗
      walletBtn.addEventListener('click', () => {
        trackEvent('shortcut_wallet_clicked');
        const walletUrl = `${baseGameUrl}?modal=wallet&tab=deposit`;
        gameFrame.src = walletUrl;
      });
      
      // 收藏按钮 - 打开收藏页面
      favoritesBtn.addEventListener('click', () => {
        trackEvent('shortcut_favorites_clicked');
        const favoritesUrl = `${baseGameUrl}games/favorites/`;
        gameFrame.src = favoritesUrl;
      });
      
      // 首页按钮 - 返回首页（带确认）
      homeBtn.addEventListener('click', () => {
        trackEvent('shortcut_home_clicked');
        
        // 显示确认弹窗
        const confirmMessage = {
          en: 'Are you sure you want to return to the homepage? Current game progress will be lost.',
          ja: 'ホームページに戻りますか？現在のゲームの進行状況は失われます。',
          zh: '确定要返回首页吗？当前游戏进度将会丢失。'
        };
        
        tg.showConfirm(confirmMessage[userLang] || confirmMessage.en, (confirmed) => {
          if (confirmed) {
            trackEvent('shortcut_home_confirmed');
            gameFrame.src = 'https://k8play7.com/';
          } else {
            trackEvent('shortcut_home_cancelled');
          }
        });
      });
    }

    // 增强的导航跟踪（处理SPA应用）
    function enhancedNavigationTracking() {
      let lastSpaUrl = '';
      
      // 监听来自K8Play的导航事件
      window.addEventListener('message', (event) => {
        // 放宽origin检查，允许来自任何域名的消息
        // if (event.origin !== baseGameUrl.replace(/\/$/, '')) return;
        
        if (event.data.type === 'navigation_change') {
          const newUrl = event.data.url;
          if (newUrl && !isNavigatingBack && newUrl !== lastSpaUrl) {
            lastSpaUrl = newUrl;
            
            if (newUrl !== navigationHistory[currentHistoryIndex]) {
              // 新导航，添加到历史记录
              navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
              navigationHistory.push(newUrl);
              currentHistoryIndex = navigationHistory.length - 1;
              
              // 显示返回按钮
              if (navigationHistory.length > 1) {
                if (tg.BackButton && tg.BackButton.show) {
                  tg.BackButton.show();
                }
                backButton.style.display = 'flex';
              }
              
              // 检查是否在外部游戏域名，显示/隐藏快捷按钮
              const isExternal = isExternalGameDomain(newUrl);
              toggleShortcutButtons(isExternal);
              
            }
          }
        }
      });
      
          // 定期检查URL变化（备用方案）- 减少频率
    let lastKnownUrl = gameFrame.src;
    setInterval(() => {
      try {
        const currentUrl = gameFrame.contentWindow.location.href;
        if (currentUrl !== lastKnownUrl && currentUrl !== 'about:blank') {
          lastKnownUrl = currentUrl;
          trackNavigation();
        }
      } catch (e) {
        // 跨域限制，尝试通过src检测
        const currentSrc = gameFrame.src;
        if (currentSrc !== lastKnownUrl && currentSrc !== 'about:blank') {
          lastKnownUrl = currentSrc;
          const isExternal = isExternalGameDomain(currentSrc);
          if (isExternal !== lastExternalState) {
            lastExternalState = isExternal;
            toggleShortcutButtons(isExternal);
          }
        }
      }
    }, 2000); // 从1秒改为2秒
    }

    // 处理返回逻辑
    function handleBack() {
      trackEvent('back_button_clicked');
      
      if (currentHistoryIndex > 0) {
        // 有历史记录，返回上一页
        isNavigatingBack = true;
        currentHistoryIndex--;
        gameFrame.src = navigationHistory[currentHistoryIndex];
        
        // 如果回到第一页，隐藏返回按钮
        if (currentHistoryIndex === 0) {
          if (tg.BackButton && tg.BackButton.hide) {
            tg.BackButton.hide();
          }
          backButton.style.display = 'none';
        }
        
        trackEvent('navigated_back', { url: navigationHistory[currentHistoryIndex] });
      } else {
        // 没有历史记录，显示退出确认
        tg.showConfirm(t.exitConfirm, (confirmed) => {
          if (confirmed) {
            trackEvent('app_exit_confirmed');
            tg.close();
          } else {
            trackEvent('app_exit_cancelled');
          }
        });
      }
    }

    // Telegram返回按钮点击（版本兼容）
    if (tg.BackButton && tg.BackButton.onClick) {
      tg.BackButton.onClick(handleBack);
    } else {
      console.log('BackButton not supported in this Telegram version');
    }
    
    // 浮动返回按钮点击
    backButton.addEventListener('click', handleBack);

    tg.onEvent('viewportChanged', resizeIframe);
    
    // 页面可见性变化追踪
    document.addEventListener('visibilitychange', () => {
      trackEvent(document.hidden ? 'app_background' : 'app_foreground');
    });

    window.addEventListener('load', loadGame);
    
    // 全局错误处理
    window.addEventListener('error', (event) => {
      console.log('全局错误:', event.error);
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.log('未处理的Promise拒绝:', event.reason);
    });
    
    // 性能监控 - 减少日志输出
    let logCount = 0;
    const originalLog = console.log;
    console.log = function(...args) {
      // 限制重复日志输出
      const message = args.join(' ');
      if (message.includes('无法访问iframe location') || 
          message.includes('隐藏快捷按钮') || 
          message.includes('显示快捷按钮')) {
        logCount++;
        if (logCount <= 3) { // 只显示前3次
          originalLog.apply(console, args);
        }
      } else {
        originalLog.apply(console, args);
      }
    };
    

  </script>
</body>
</html>
