<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PlayK8 - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://k8play7.com/">
  <link rel="dns-prefetch" href="https://k8play7.com/">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; width: 100%; background-color: #121212; }
    .container { display: flex; flex-direction: column; min-height: 100%; width: 100%; position: relative; }
    iframe { flex: 1; width: 100%; height: 100%; border: none; }
    
    .back-button {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      transition: background-color 0.2s;
    }
    
    .back-button:hover {
      background-color: rgba(0, 0, 0, 0.9);
    }
    
    .back-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-button" id="backButton">
      <svg viewBox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
    </div>
    <iframe id="gameFrame" src="about:blank" allowfullscreen allow="camera; microphone; geolocation; payment; usb; magnetometer; gyroscope; accelerometer; ambient-light-sensor; autoplay; encrypted-media; midi; sync-xhr; clipboard-read; clipboard-write" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-storage-access-by-user-activation allow-top-navigation"></iframe>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const param = tg.initDataUnsafe?.start_param;
    const userId = tg.initDataUnsafe?.user?.id;
    const username = tg.initDataUnsafe?.user?.username;
    const firstName = tg.initDataUnsafe?.user?.first_name;

    const userLang = tg.initDataUnsafe?.user?.language_code || 'en';
    const translations = {
      en: { exitConfirm: 'Are you sure you want to exit the game?' },
      ja: { exitConfirm: 'ゲームを終了してもよろしいですか？' },
      zh: { exitConfirm: '确定要退出游戏吗？' }
    };
    const t = translations[userLang] || translations.en;

    const gameFrame = document.getElementById('gameFrame');
    const backButton = document.getElementById('backButton');

    // 构建包含用户信息的游戏URL
    const baseGameUrl = 'https://k8play7.com/';
    const urlParams = new URLSearchParams();
    if (param) urlParams.append('invite', param);
    if (userId) urlParams.append('tg_user_id', userId);
    if (username) urlParams.append('tg_username', username);
    if (firstName) urlParams.append('tg_first_name', firstName);
    urlParams.append('tg_lang', userLang);
    urlParams.append('tg_platform', tg.platform);
    urlParams.append('tg_version', tg.version);
    urlParams.append('tg_theme', tg.colorScheme || 'light');
    urlParams.append('tg_init_data', tg.initData || '');
    
    // 添加登录状态标识
    urlParams.append('tg_source', 'telegram_mini_app');
    urlParams.append('tg_auto_login', 'true');
    
    const gameUrl = urlParams.toString() ? `${baseGameUrl}?${urlParams.toString()}` : baseGameUrl;

    // 网络状态监测
    let isOnline = navigator.onLine;
    window.addEventListener('online', () => {
      isOnline = true;
      trackEvent('network_online');
      gameFrame.contentWindow?.postMessage({
        type: 'network_status',
        online: true
      }, baseGameUrl);
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      trackEvent('network_offline');
      tg.showAlert('网络连接已断开 / Network disconnected / ネットワーク接続が切断されました');
      gameFrame.contentWindow?.postMessage({
        type: 'network_status',
        online: false
      }, baseGameUrl);
    });

    // 设备信息
    function getDeviceInfo() {
      return {
        platform: tg.platform,
        version: tg.version,
        colorScheme: tg.colorScheme,
        viewportHeight: tg.viewportHeight,
        viewportStableHeight: tg.viewportStableHeight,
        isExpanded: tg.isExpanded,
        language: userLang,
        online: isOnline
      };
    }

    // 用户行为分析
    function trackEvent(eventName, data = {}) {
      const eventData = {
        event: eventName,
        user_id: userId,
        username: username,
        platform: tg.platform,
        timestamp: new Date().toISOString(),
        ...data
      };
      
      // 发送给游戏iframe
      if (gameFrame.contentWindow) {
        gameFrame.contentWindow.postMessage({
          type: 'tg_analytics',
          data: eventData
        }, baseGameUrl);
      }
      
      console.log('Track event:', eventData);
    }

    function loadGame() {
      trackEvent('app_start', { invite_code: param });
      
      // 尝试恢复登录状态
      const savedLoginState = localStorage.getItem('k8play_login_state');
      let finalGameUrl = gameUrl;
      
      if (savedLoginState) {
        try {
          const loginData = JSON.parse(savedLoginState);
          // 如果登录状态未过期，使用保存的URL
          if (loginData.expiresAt && new Date() < new Date(loginData.expiresAt)) {
            finalGameUrl = loginData.url;
            console.log('恢复登录状态:', loginData);
          }
        } catch (e) {
          console.log('登录状态恢复失败:', e);
        }
      }
      
      gameFrame.src = finalGameUrl;
      gameFrame.onload = () => {
        tg.ready();
        trackEvent('game_loaded');
        
        // 初始化导航历史
        navigationHistory = [finalGameUrl];
        currentHistoryIndex = 0;
        
        // 开始跟踪导航
        trackNavigation();
        
        // 启用增强的导航跟踪
        enhancedNavigationTracking();
        
        // 设置定时器监听URL变化（对于单页应用）
        setInterval(trackNavigation, 500);
        
        // 监听登录状态变化
        setTimeout(() => {
          gameFrame.contentWindow.postMessage({
            type: 'request_login_state',
            user_id: userId,
            username: username
          }, baseGameUrl);
          
          // 注入登录状态管理脚本到游戏页面
          injectLoginStateScript();
          
          // 检查并处理自动登录
          checkAndHandleAutoLogin();
        }, 2000);
      };
      gameFrame.onerror = () => {
        console.error('Failed to load game');
        tg.showAlert('Failed to load game. Please try again later.');
        trackEvent('game_load_error');
      };
    }

    let resizeTimeout;
    function resizeIframe() {
      if (resizeTimeout) cancelAnimationFrame(resizeTimeout);
      resizeTimeout = requestAnimationFrame(() => {
        gameFrame.style.height = window.innerHeight + 'px';
      });
    }

    resizeIframe();
    window.addEventListener('resize', resizeIframe);

    // 自动登录检测和处理
    function checkAndHandleAutoLogin() {
      // 检查是否有保存的登录状态
      const savedLoginState = localStorage.getItem('k8play_login_state');
      if (savedLoginState) {
        try {
          const loginData = JSON.parse(savedLoginState);
          if (loginData.expiresAt && new Date() < new Date(loginData.expiresAt)) {
            // 登录状态有效，尝试自动登录
            console.log('检测到有效登录状态，尝试自动登录');
            
            // 向游戏发送自动登录请求
            setTimeout(() => {
              gameFrame.contentWindow.postMessage({
                type: 'auto_login_request',
                user_id: loginData.user_id,
                username: loginData.username,
                saved_url: loginData.url
              }, baseGameUrl);
            }, 1000);
          }
        } catch (e) {
          console.log('登录状态解析失败:', e);
        }
      }
    }

    // 注入登录状态管理脚本到游戏页面
    function injectLoginStateScript() {
      try {
        const script = `
          (function() {
            // 登录状态管理
            window.k8playLoginManager = {
              // 检查是否在Telegram环境中
              isInTelegram: function() {
                return window.parent && window.parent !== window && 
                       window.parent.location.href.includes('telegram');
              },
              
              // 检查用户是否已登录
              isUserLoggedIn: function() {
                // 检查常见的登录标识
                return !!(
                  document.cookie.includes('session') ||
                  document.cookie.includes('token') ||
                  document.cookie.includes('auth') ||
                  localStorage.getItem('user') ||
                  localStorage.getItem('token') ||
                  localStorage.getItem('session') ||
                  document.querySelector('[data-user]') ||
                  document.querySelector('.user-info') ||
                  document.querySelector('.logged-in')
                );
              },
              
              // 保存登录状态
              saveLoginState: function() {
                if (this.isInTelegram()) {
                  window.parent.postMessage({
                    type: 'save_login_state',
                    url: window.location.href
                  }, '*');
                  console.log('登录状态已保存到Telegram应用');
                }
              },
              
              // 清除登录状态
              clearLoginState: function() {
                if (this.isInTelegram()) {
                  window.parent.postMessage({
                    type: 'clear_login_state'
                  }, '*');
                  console.log('登录状态已从Telegram应用清除');
                }
              },
              
              // 监听登录状态请求
              init: function() {
                // 监听来自Telegram的消息
                window.addEventListener('message', (event) => {
                  if (event.data.type === 'request_login_state') {
                    if (this.isUserLoggedIn()) {
                      this.saveLoginState();
                    }
                  }
                });
                
                               // 监听页面变化（用于单页应用）
               let currentUrl = window.location.href;
               const observer = new MutationObserver(() => {
                 if (window.location.href !== currentUrl) {
                   currentUrl = window.location.href;
                   if (this.isUserLoggedIn()) {
                     this.saveLoginState();
                   }
                   
                   // 发送导航变化事件到Telegram应用
                   if (this.isInTelegram()) {
                     window.parent.postMessage({
                       type: 'navigation_change',
                       url: window.location.href
                     }, '*');
                   }
                 }
               });
               observer.observe(document.body, { childList: true, subtree: true });
               
               // 监听pushState和replaceState（SPA路由变化）
               const originalPushState = history.pushState;
               const originalReplaceState = history.replaceState;
               
               history.pushState = function() {
                 originalPushState.apply(this, arguments);
                 if (window.k8playLoginManager.isInTelegram()) {
                   window.parent.postMessage({
                     type: 'navigation_change',
                     url: window.location.href
                   }, '*');
                 }
               };
               
               history.replaceState = function() {
                 originalReplaceState.apply(this, arguments);
                 if (window.k8playLoginManager.isInTelegram()) {
                   window.parent.postMessage({
                     type: 'navigation_change',
                     url: window.location.href
                   }, '*');
                 }
               };
               
               // 监听popstate事件（浏览器前进后退）
               window.addEventListener('popstate', () => {
                 if (window.k8playLoginManager.isInTelegram()) {
                   window.parent.postMessage({
                     type: 'navigation_change',
                     url: window.location.href
                   }, '*');
                 }
               });
                
                // 监听表单提交（登录表单）
                document.addEventListener('submit', (event) => {
                  const form = event.target;
                  if (form.action && form.action.includes('login')) {
                    // 延迟检查登录状态
                    setTimeout(() => {
                      if (this.isUserLoggedIn()) {
                        this.saveLoginState();
                      }
                    }, 1000);
                  }
                });
                
                // 监听AJAX请求完成
                const originalXHROpen = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function() {
                  this.addEventListener('load', function() {
                    if (this.responseURL && this.responseURL.includes('login')) {
                      setTimeout(() => {
                        if (window.k8playLoginManager.isUserLoggedIn()) {
                          window.k8playLoginManager.saveLoginState();
                        }
                      }, 500);
                    }
                  });
                  originalXHROpen.apply(this, arguments);
                };
                
                // 监听fetch请求
                const originalFetch = window.fetch;
                window.fetch = function() {
                  return originalFetch.apply(this, arguments).then(response => {
                    if (response.url && response.url.includes('login')) {
                      setTimeout(() => {
                        if (window.k8playLoginManager.isUserLoggedIn()) {
                          window.k8playLoginManager.saveLoginState();
                        }
                      }, 500);
                    }
                    return response;
                  });
                };
                
                // 定期检查登录状态
                setInterval(() => {
                  if (this.isUserLoggedIn()) {
                    this.saveLoginState();
                  }
                }, 30000); // 每30秒检查一次
                
                console.log('K8Play登录状态管理器已初始化');
              }
            };
            
            // 初始化登录状态管理器
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', () => {
                window.k8playLoginManager.init();
              });
            } else {
              window.k8playLoginManager.init();
            }
            
            // 添加退出登录监听
            document.addEventListener('click', (event) => {
              const target = event.target;
              if (target.textContent.toLowerCase().includes('logout') ||
                  target.textContent.toLowerCase().includes('退出') ||
                  target.textContent.toLowerCase().includes('登出') ||
                  target.href && target.href.includes('logout')) {
                setTimeout(() => {
                  window.k8playLoginManager.clearLoginState();
                }, 500);
              }
            });
          })();
        `;
        
        // 尝试注入脚本到游戏页面
        if (gameFrame.contentWindow) {
          const scriptElement = gameFrame.contentWindow.document.createElement('script');
          scriptElement.textContent = script;
          gameFrame.contentWindow.document.head.appendChild(scriptElement);
          console.log('登录状态管理脚本已注入到游戏页面');
        }
      } catch (e) {
        console.log('注入脚本失败（跨域限制）:', e.message);
        // 如果无法直接注入，通过postMessage发送脚本
        gameFrame.contentWindow.postMessage({
          type: 'inject_login_script',
          script: script
        }, baseGameUrl);
      }
    }

    // 监听来自游戏的消息
    window.addEventListener('message', (event) => {
      if (event.origin !== baseGameUrl.replace(/\/$/, '')) return;
      
      // 处理游戏发来的消息
      if (event.data.type === 'game_event') {
        trackEvent(event.data.eventName, event.data.data);
      }
      
      // 处理登录状态保存
      if (event.data.type === 'save_login_state') {
        try {
          const loginState = {
            url: event.data.url || gameFrame.src,
            user_id: userId,
            username: username,
            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7天过期
            savedAt: new Date().toISOString()
          };
          localStorage.setItem('k8play_login_state', JSON.stringify(loginState));
          console.log('登录状态已保存:', loginState);
        } catch (e) {
          console.error('保存登录状态失败:', e);
        }
      }
      
      // 处理登录状态清除
      if (event.data.type === 'clear_login_state') {
        try {
          localStorage.removeItem('k8play_login_state');
          console.log('登录状态已清除');
        } catch (e) {
          console.error('清除登录状态失败:', e);
        }
      }
      
      // 处理脚本注入请求
      if (event.data.type === 'inject_login_script') {
        try {
          const scriptElement = document.createElement('script');
          scriptElement.textContent = event.data.script;
          document.head.appendChild(scriptElement);
          console.log('登录状态管理脚本已通过postMessage注入');
        } catch (e) {
          console.error('脚本注入失败:', e);
        }
      }
      
      // 处理自动登录响应
      if (event.data.type === 'auto_login_response') {
        if (event.data.success) {
          console.log('自动登录成功');
          trackEvent('auto_login_success');
        } else {
          console.log('自动登录失败:', event.data.reason);
          trackEvent('auto_login_failed', { reason: event.data.reason });
        }
      }
      
      // 处理游戏请求Telegram操作
      if (event.data.type === 'tg_action') {
        switch (event.data.action) {
          case 'close':
            tg.close();
            break;
          case 'share':
            // 实现分享功能
            if (event.data.text && event.data.url) {
              const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(event.data.url)}&text=${encodeURIComponent(event.data.text)}`;
              tg.openTelegramLink(shareUrl);
            }
            break;
          case 'show_alert':
            tg.showAlert(event.data.message);
            break;
          case 'show_confirm':
            tg.showConfirm(event.data.message, (confirmed) => {
              gameFrame.contentWindow.postMessage({
                type: 'tg_confirm_result',
                id: event.data.id,
                confirmed: confirmed
              }, baseGameUrl);
            });
            break;
          case 'show_popup':
            if (event.data.params) {
              tg.showPopup(event.data.params, (buttonId) => {
                gameFrame.contentWindow.postMessage({
                  type: 'tg_popup_result',
                  id: event.data.id,
                  buttonId: buttonId
                }, baseGameUrl);
              });
            }
            break;
          case 'request_contact':
            tg.requestContact((shared) => {
              gameFrame.contentWindow.postMessage({
                type: 'tg_contact_result',
                shared: shared
              }, baseGameUrl);
            });
            break;
          case 'haptic':
            // 触觉反馈
            if (tg.HapticFeedback) {
              switch (event.data.style) {
                case 'light':
                  tg.HapticFeedback.impactOccurred('light');
                  break;
                case 'medium':
                  tg.HapticFeedback.impactOccurred('medium');
                  break;
                case 'heavy':
                  tg.HapticFeedback.impactOccurred('heavy');
                  break;
                case 'success':
                  tg.HapticFeedback.notificationOccurred('success');
                  break;
                case 'warning':
                  tg.HapticFeedback.notificationOccurred('warning');
                  break;
                case 'error':
                  tg.HapticFeedback.notificationOccurred('error');
                  break;
              }
            }
            break;
          case 'open_link':
            if (event.data.url) {
              tg.openLink(event.data.url);
            }
            break;
          case 'set_header_color':
            if (event.data.color) {
              tg.setHeaderColor(event.data.color);
            }
            break;
          case 'set_background_color':
            if (event.data.color) {
              tg.setBackgroundColor(event.data.color);
            }
            break;
          case 'get_device_info':
            gameFrame.contentWindow.postMessage({
              type: 'device_info',
              data: getDeviceInfo()
            }, baseGameUrl);
            break;
          case 'enable_closing_confirmation':
            tg.enableClosingConfirmation();
            break;
          case 'disable_closing_confirmation':
            tg.disableClosingConfirmation();
            break;
          case 'ready_to_close':
            tg.ready();
            break;
          case 'scan_qr':
            if (tg.showScanQrPopup) {
              tg.showScanQrPopup({
                text: event.data.text || 'Scan QR Code'
              }, (text) => {
                gameFrame.contentWindow.postMessage({
                  type: 'qr_scan_result',
                  text: text || null
                }, baseGameUrl);
              });
            }
            break;
          case 'request_write_access':
            if (tg.requestWriteAccess) {
              tg.requestWriteAccess((granted) => {
                gameFrame.contentWindow.postMessage({
                  type: 'write_access_result',
                  granted: granted
                }, baseGameUrl);
              });
            }
            break;
          case 'request_phone':
            if (tg.requestContact) {
              tg.requestContact((result) => {
                gameFrame.contentWindow.postMessage({
                  type: 'phone_result',
                  result: result
                }, baseGameUrl);
              });
            }
            break;
          case 'open_invoice':
            if (event.data.url && tg.openInvoice) {
              tg.openInvoice(event.data.url, (status) => {
                gameFrame.contentWindow.postMessage({
                  type: 'invoice_status',
                  status: status
                }, baseGameUrl);
              });
            }
            break;
          case 'navigate_to':
            // 游戏请求导航到指定URL
            if (event.data.url) {
              gameFrame.src = event.data.url;
            }
            break;
        }
      }
    });

    // 跟踪iframe导航历史
    let navigationHistory = [];
    let currentHistoryIndex = -1;
    let isNavigatingBack = false;

    // 监听iframe导航
    function trackNavigation() {
      try {
        const currentUrl = gameFrame.contentWindow.location.href;
        if (!isNavigatingBack && currentUrl !== 'about:blank' && currentUrl !== navigationHistory[currentHistoryIndex]) {
          // 新导航，清除前进历史
          navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
          navigationHistory.push(currentUrl);
          currentHistoryIndex = navigationHistory.length - 1;
          
          // 如果有多个页面，显示返回按钮
          if (navigationHistory.length > 1) {
            tg.BackButton.show();
            backButton.style.display = 'flex';
          }
          
          console.log('导航历史更新:', {
            current: currentUrl,
            history: navigationHistory,
            index: currentHistoryIndex
          });
        }
        isNavigatingBack = false;
      } catch (e) {
        // 跨域时无法访问contentWindow.location
        console.log('无法访问iframe location（跨域限制）');
      }
    }
    
    // 增强的导航跟踪（处理SPA应用）
    function enhancedNavigationTracking() {
      // 监听来自K8Play的导航事件
      window.addEventListener('message', (event) => {
        if (event.origin !== baseGameUrl.replace(/\/$/, '')) return;
        
        if (event.data.type === 'navigation_change') {
          const newUrl = event.data.url;
          if (newUrl && !isNavigatingBack && newUrl !== navigationHistory[currentHistoryIndex]) {
            // 新导航，添加到历史记录
            navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
            navigationHistory.push(newUrl);
            currentHistoryIndex = navigationHistory.length - 1;
            
            // 显示返回按钮
            if (navigationHistory.length > 1) {
              tg.BackButton.show();
              backButton.style.display = 'flex';
            }
            
            console.log('SPA导航检测:', {
              url: newUrl,
              history: navigationHistory,
              index: currentHistoryIndex
            });
          }
        }
      });
      
      // 定期检查URL变化（备用方案）
      let lastKnownUrl = gameFrame.src;
      setInterval(() => {
        try {
          const currentUrl = gameFrame.contentWindow.location.href;
          if (currentUrl !== lastKnownUrl && currentUrl !== 'about:blank') {
            lastKnownUrl = currentUrl;
            trackNavigation();
          }
        } catch (e) {
          // 跨域限制，忽略
        }
      }, 1000);
    }

    // 处理返回逻辑
    function handleBack() {
      trackEvent('back_button_clicked');
      
      if (currentHistoryIndex > 0) {
        // 有历史记录，返回上一页
        isNavigatingBack = true;
        currentHistoryIndex--;
        gameFrame.src = navigationHistory[currentHistoryIndex];
        
        // 如果回到第一页，隐藏返回按钮
        if (currentHistoryIndex === 0) {
          tg.BackButton.hide();
          backButton.style.display = 'none';
        }
        
        trackEvent('navigated_back', { url: navigationHistory[currentHistoryIndex] });
      } else {
        // 没有历史记录，显示退出确认
        tg.showConfirm(t.exitConfirm, (confirmed) => {
          if (confirmed) {
            trackEvent('app_exit_confirmed');
            tg.close();
          } else {
            trackEvent('app_exit_cancelled');
          }
        });
      }
    }

    // Telegram返回按钮点击
    tg.BackButton.onClick(handleBack);
    
    // 浮动返回按钮点击
    backButton.addEventListener('click', handleBack);

    tg.onEvent('viewportChanged', resizeIframe);
    
    // 页面可见性变化追踪
    document.addEventListener('visibilitychange', () => {
      trackEvent(document.hidden ? 'app_background' : 'app_foreground');
    });

    window.addEventListener('load', loadGame);
  </script>
</body>
</html>
